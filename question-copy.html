<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שאלה הלכתית</title>
    <style>
        .bg-royal-blue { background-color: #4169E1; }
        .text-royal-blue { color: #4169E1; }
        .tag-box {
            position: relative;
            width: fit-content;
            height: fit-content;
            transition: all 0.3s ease;
            overflow: hidden;
            padding: 10px 10px 10px 0px;
        }
        .tag-box * {
            margin-left: 10px;
        }
        .tag-flex-box {
            display: flex;
            gap: 0;
            align-items: center;
        }
        .tag {
            display: inline-block;
            background-color: #4169E1;
            color: white;
            border-radius: 5px;
        }
        .btn {
            background-color: white;
            color: #6b7280;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            text-align: center;
            border-radius: 5px;
            margin: 0 !important;
            padding: 0;
            width: 0px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .tag-box:hover .btn,
        .tag-box.hovered .btn{
            width: fit-content;
            opacity: 1;
            padding: 3px 6px;
            margin-left: 10px !important;
            pointer-events: all;
        }

        button.selected {
            background-color: #f9fafb;
            color: #003277;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .fade-out {
            opacity: 0;
            transform: scale(0.95);
        }
    </style>
    <link href="output.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md relative">
        <h1 id="question-text" class="text-royal-blue text-2xl font-semibold mb-4">טוען שאלה...</h1>
        <div id="answers-container">
            <!-- תשובות יתווספו כאן באופן דינמי -->
        </div>

        <button class="mt-4 bg-royal-blue text-white px-4 py-2 rounded">+ הוסף שיטה</button>
        <button id="send-btn" class="absolute bottom-2 left-2 bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out group">שלח</button>
    </div>

    <script type="module">
        import { Posek } from './Shita/Posek.js';
        let questions = [];
        let poskimList = [];
        let poskimOptions = "";
        let svaraOpts = "";
        let halachaOpts = "";
        let currentQuestion = null;
        let answeredQuestions;
        let answerCount = 0;
        const childCounts = {};
        let hasSvarot = false;
        let hasHalachas = false;
        let selectedPosekTags = [];

        // Stance configuration object
        const STANCES = {
        sover: {
            label: 'סובר',
            // which fields must exist on an answer of this stance
            requires: ['svara'],
            // for UI: how many halacha selects to show
            halachaCount: 0
        },
        posek: {
            label: 'פוסק',
            requires: ['svara','halacha'],
            halachaCount: 1
        },
        metzaded: {
            label: 'מצדד',
            requires: ['svara','halacha'],
            halachaCount: 1
        },
        mistapek: {
            label: 'מסתפק',
            requires: ['halacha'],
            halachaCount: 2
        },
        lechatchila: {
            label: 'לכתחילה - בדיעבד',
            requires: ['halacha'],
            halachaCount: 2
        }
        };

        // טוען את רשימת הפוסקים מקובץ poskim.txt
        window.addEventListener('DOMContentLoaded', async () => {
            questions = await fetch('shabat.json').then(response => response.json());
            poskimList = await fetch('poskim.txt').then(response => response.text()).then(text => text.split('\n').map(l => l.trim()).filter(l => l));
            poskimOptions = getOptionsHTML(poskimList);
            loadRandomQuestion();
            const sendButton = document.getElementById('send-btn');
            sendButton.addEventListener('click', sendAnswers);
            sendButton.previousElementSibling.addEventListener('click', addAnswerField);
        });

        function loadRandomQuestion() {
            // pick random
            answeredQuestions = JSON.parse(localStorage.getItem('answeredQuestions')) || [];
            currentQuestion = questions.filter(q => !answeredQuestions.includes(q.id))[Math.floor(Math.random() * questions.length)];
            document.getElementById('question-text').innerText = currentQuestion.question;
            svaraOpts = getOptionsHTML(currentQuestion.svarot);
            halachaOpts = getOptionsHTML(currentQuestion.psakim);
            hasSvarot   = Array.isArray(currentQuestion.svarot)   && currentQuestion.svarot.length  > 0;
            hasHalachas = Array.isArray(currentQuestion.psakim)   && currentQuestion.psakim.length  > 0;

            // clear existing answers
            document.getElementById('answers-container').innerHTML = '';
            answerCount = 0;
            addAnswerField();
        }

        function esc(str) {
            return str.replace(/"/g, '&quot;')
        }

        function unesc(str) {
            return str.replace(/&quot;/g, '"')
        }
        
        function getOptionsHTML(list) {
            return list.map(p => `<option value="${esc(p)}">${p}</option>`).join('');
        }

        function stanceInnerHTML(posekIndex, stanceIndex) {
            return `   
                <div class="mb-2">
                    <label class="block text-sm font-medium">מהי עמדתו?</label>
                    <select id="stance-select-${posekIndex}-${stanceIndex}" class="w-full p-2 border rounded">
                    </select>
                </div>
                <div class="mb-2" id="halacha-${posekIndex}-${stanceIndex}">
                    <div id="halacha1-${posekIndex}-${stanceIndex}">
                        <label class="block text-sm font-medium">מהי ההלכה?</label>
                        <select class="w-full p-2 border rounded">
                            <option value="">בחר הלכה</option>
                            ${halachaOpts}
                        </select>
                    </div>
                    <div id="halacha2-${posekIndex}-${stanceIndex}">
                        <label class="block text-sm font-medium">מהי ההלכה המשנית?</label>
                        <select class="w-full p-2 border rounded">
                            <option value="">בחר הלכה משנית</option>
                            ${halachaOpts}
                        </select>
                    </div>
                    <div id="svara-${posekIndex}-${stanceIndex}">
                        <label class="block text-sm font-medium">מהי סברתו?</label>
                        <select class="w-full p-2 border rounded">
                            <option value="">בחר סברא</option>
                            ${svaraOpts}
                        </select>
                    </div>
                </div>
                <button class="absolute text-xs top-2 left-2 bg-red-500 text-white px-1 py-0.3 rounded">מחק עמדה</button>
            `;
        }

        function answerInnerHTML(index) {
            return `
                <label class="block mb-2 font-medium answer-label">שיטה ${index}:</label>
                <div class="mb-2">
                    <label class="block text-sm font-medium">מי אומר כך?</label>
                    <select class="w-full p-2 border rounded">
                        <option value="">בחר פוסק</option>
                        ${poskimOptions}
                    </select>
                    <div id="posek-tags-${index}" class="mt-2 flex gap-2"></div>
                </div>
                <div class="class-container" id="stances-${index}">
                    
                </div>
                <button class="bg-blue-500 text-sm text-white px-1 py-0.5 rounded" data-role="add-stance">+ הוסף עמדה</button>
                <button class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded" data-role="remove-answer">מחק</button>
                `;
        }

        function addAnswerField() {
            const index = ++answerCount;
            childCounts[index] = 0;
            const container = document.getElementById("answers-container");
            const answerDiv = document.createElement("div");
            answerDiv.className = "mb-4 p-4 border rounded bg-gray-50 relative";
            answerDiv.id = `answer-${index}`;
            answerDiv.innerHTML = answerInnerHTML(index);
            answerDiv.querySelectorAll(':scope > div > select').forEach(sel => sel.addEventListener('change', () => addPosek(index, sel)));
            answerDiv.querySelector('[data-role="add-stance"]').addEventListener('click', () => addStance(index));
            answerDiv.querySelector('[data-role="remove-answer"]').addEventListener('click', () => removeAnswer(index));
            container.appendChild(answerDiv);
            addStance(index);
            updateDeleteButtons();
        }

        function addPosek(index, select) {
            const posek = unesc(select.value);
            select.blur();
            if (!posek) return;

            if (selectedPosekTags.length === 0) {
                const tagContainer = document.getElementById('posek-tags-' + index);
                if (tagContainer.innerHTML.includes(posek)) return; // prevent duplicates
                const tagIdx = tagContainer.children.length;
                const tag = document.createElement("div");
                tag.id = "tag-" + index + '-' + tagIdx;
                tag.classList.add('tag-box', 'bg-royal-blue', 'rounded');
                tag.innerHTML = `<span class="tag font-bold">${posek}</span><button class="btn">בדעת</button>`;
                tag.onclick = removeTag;
                const bdaatButton = tag.querySelector('button');
                bdaatButton.addEventListener('click', () => selectChildPosek(bdaatButton));
                tagContainer.appendChild(tag);
                select.value = "";
            } else { // add child posek
                const tagContainers = selectedPosekTags.map(posekTag => document.getElementById(posekTag));
                tagContainers.filter(tc => !tc.innerHTML.includes(posek)); // prevent duplicates
                if (tagContainers.length === 0) return;
                tagContainers.forEach(tc => {
                    const tag = document.createElement('span');
                    tag.classList.add('transition-all', 'duration-300', 'ease-in-out',  'bg-blue-500', 'text-white', 'rounded', 'px-2', 'py-1', 'text-sm');
                    tag.textContent = posek;
                    tag.dataset.role = 'parent-posek';
                    deselect(tc.querySelector('button')); // deselect the 'בדעת' button
                    tag.onclick = removeTag;
                    tc.appendChild(tag);
                    select.value = "";
                })
            }
        }

        function deselect(button) {
            button.classList.remove('selected');
            button.closest('.tag-box').classList.remove('hovered');
            selectedPosekTags = [];
        }

        function selectChildPosek(button) {
            event.stopPropagation();
            const parentBox = button.closest('.tag-box');
            if (button.classList.contains('selected')) {
                deselect(button);
            } else {
                // Select
                button.classList.add('selected');
                parentBox.classList.add('hovered');
                selectedPosekTags.push(parentBox.id);
            }
        }

        function removeTag() {
            event.stopPropagation();
            const tag = event.currentTarget;
            tag.addEventListener('transitionend', () => tag.remove(), { once: true});
            tag.classList.add('fade-out');
            if (tag.id) {
                // Re-index remaining tags
                const remainedTags = tag.parentElement.children;
                const index = tag.id.split('-')[1];
                if (selectedPosekTags == tag.id) selectedPosekTags = '';
                for (let i = 0; i < remainedTags.length; i++) {
                    remainedTags[i].id = "tag-" + index + '-' + i;
                }
            }
        }

        function addStance(posekIndex) {
            const container = document.getElementById(`stances-${posekIndex}`);
            const stanceCount = container.children.length + 1;
            const stanceDiv = document.createElement("div");
            container.appendChild(stanceDiv);
            stanceDiv.classList.add('stance-block', 'border', 'rounded', 'p-2', 'mb-2', 'bg-white', 'relative');
            stanceDiv.innerHTML = stanceInnerHTML(posekIndex, stanceCount);
            stanceDiv.querySelector('button').addEventListener('click', () => removeStance(stanceDiv));
            const stanceSelect = stanceDiv.querySelector('select');
            const halachaFields = stanceDiv.querySelector('#halacha-' + posekIndex + '-' + stanceCount).children;
            stanceSelect.addEventListener('change', () => toggleHalachaFields(stanceSelect.value, halachaFields[2], [halachaFields[0], halachaFields[1]]));
            buildStanceOptions(stanceSelect);
            toggleHalachaFields(stanceSelect.value, halachaFields[2], [halachaFields[0], halachaFields[1]]);
            updateStanceDeleteButtons(container);
        }

        function removeStance(stance) {
            const container = stance.parentElement;
            stance.remove();
            updateStanceDeleteButtons(container);
        }

        function updateStanceDeleteButtons(container) {
            const stanceBlocks = container.querySelectorAll('.stance-block');
            stanceBlocks.forEach((block, i) => {
                const deleteBtn = block.querySelector('button');
                deleteBtn.classList.toggle('hidden', stanceBlocks.length <= 1);
            });
        }

        function buildStanceOptions(stanceSelect) {
            
            Object.entries(STANCES).forEach(([key, cfg]) => {
                // decide whether this stance is valid for this question
                let disabled = false;
                if (!hasHalachas && key !== 'sover') {
                // No halacha options → only sover allowed
                disabled = true;
                }
                if (!hasSvarot && key === 'sover') {
                // No svarot → sover not allowed
                disabled = true;
                }
                const opt = document.createElement('option');
                opt.value    = key;
                opt.text     = cfg.label;
                opt.disabled = disabled;
                stanceSelect.appendChild(opt);
            });
        }

        function toggleHalachaFields(stanceKey, svaraWrapper, halachaWrappers) {
            const baseCfg = STANCES[stanceKey];

            const cfg = {...baseCfg};

            if (!hasSvarot && (stanceKey === 'posek' || stanceKey === 'metzaded')) {
                cfg.requires = ['halacha'];
            }

            // Svara field
            if (cfg.requires.includes('svara')) {
                svaraWrapper.style.display = 'block';
            } else {
                svaraWrapper.style.display = 'none';
            }

            // Halacha fields
            halachaWrappers.forEach((w, i) => {
                if (i < cfg.halachaCount) {
                    w.style.display = 'block';
                    if (i === 1) {
                        let firstOption = w.querySelector('select').options[0];
                        if (stanceKey === 'lechatchila') {
                            w.querySelector('label').textContent = 'מהי ההלכה בדיעבד?'
                            firstOption.textContent = 'בחר הלכה בדיעבד';
                        } else if (i === 1 && stanceKey === 'mistapek') {
                            w.querySelector('label').textContent = 'מהי ההלכה המשנית?'
                            firstOption.textContent = 'בחר הלכה משנית';
                        }
                    }
                } else {
                    w.style.display = 'none';
                }
            });

            // If multiple Halachas needed, wire up mutual exclusion:
            if (cfg.halachaCount === 2) {
                setupMutualExclusion(
                halachaWrappers[0].querySelector('select'),
                halachaWrappers[1].querySelector('select')
                );
            }
        }

        function setupMutualExclusion(select1, select2) {
            select1.addEventListener('change', () => updateDisabledOptions(select1, select2));
            select2.addEventListener('change', () => updateDisabledOptions(select2, select1));
        }

        function updateDisabledOptions(sourceSelect, targetSelect) {
            const selectedValue = sourceSelect.value;
            Array.from(targetSelect.options).forEach(opt => {
                if (opt.value === selectedValue && selectedValue !== '') {
                    opt.disabled = true;
                } else {
                    opt.disabled = false;
                }
            });
        }

        function removeAnswer(index) {
            document.getElementById(`answer-${index}`).remove();
            updateDeleteButtons();
            updateAnswerLabels();
        }

        function updateDeleteButtons() {
            const answers = document.querySelectorAll("[id^='answer-']");
            const display = answers.length > 1 ? "block" : "none";
            answers.forEach(a => a.querySelector("[data-role='remove-answer']").style.display = display);
        }

        function updateAnswerLabels() {
            document.querySelectorAll("[id^='answer-']").forEach((answer, i) => answer.querySelector(".answer-label").textContent = `שיטה ${i + 1}:`);
        }

        function collectStanceFields(stanceBlock) {
            let result = {};
            const stanceKey = stanceBlock.querySelector('[id^="stance"]').value;
            result.stance = stanceKey;
            const fields = Array.from(stanceBlock.querySelector('[id^="halacha"]').children).filter(e => getComputedStyle(e).display !== 'none');
            fields.forEach(field => {
                result[field.id.split('-')[0]] = field.querySelector('select').value;
            });
            return result;
        }

        function collectUserAnswers() {
            const answers = [];
            const answerElements = document.querySelectorAll('[id^="answer-"]');
            
            answerElements.forEach(answer => {
                const id = answer.id.slice(7);
                const posekTags = Array.from(answer.querySelectorAll(`#posek-tags-${id} > .tag-box`));
                const poskim = posekTags.map(tagBox => new Posek(tagBox.querySelector('.tag').textContent, tagBox.querySelectorAll('[data-role="parent-posek"]').forEach(t => t.textContent)));
                const stanceBlocks = Array.from(answer.querySelectorAll(`.stance-block`));
                const stances = stanceBlocks.map(collectStanceFields);
                answers.push({
                    poskim: poskim,
                    stances: stances
                })
            })
            return answers;
        }

        function sendAnswers() {
            sessionStorage.setItem('userAnswers', JSON.stringify(collectUserAnswers(), null, 2));
            sessionStorage.setItem('correctAnswers', JSON.stringify(currentQuestion.answers, null, 2));
            let answeredQuestions = JSON.parse(localStorage.getItem('answeredQuestions')) || [];
            answeredQuestions.push(currentQuestion.id);
            localStorage.setItem('answeredQuestions', JSON.stringify(answeredQuestions));
            window.location.href = "results.html";
        }
    </script>
</body>
</html>
