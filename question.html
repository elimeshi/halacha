<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שאלה הלכתית</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-royal-blue { background-color: #4169E1; }
        .text-royal-blue { color: #4169E1; }
        .tag {
            display: inline-block;
            background-color: #4169E1;
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 id="question-text" class="text-royal-blue text-2xl font-semibold mb-4">טוען שאלה...</h1>
        <div id="answers-container">
            <!-- תשובות יתווספו כאן באופן דינמי -->
        </div>

        <button onclick="addAnswerField()" class="mt-4 bg-royal-blue text-white px-4 py-2 rounded">+ הוסף שיטה</button>
    </div>

    <script>
        let questions = [];
        let poskimList = [];
        let poskimOptions = "";
        let svaraOpts = "";
        let halachaOpts = "";
        let currentQuestion = null;
        let answerCount = 0;
        const childCounts = {};

        // טוען את רשימת הפוסקים מקובץ poskim.txt
        window.addEventListener('DOMContentLoaded', async () => {
            questions = await fetch('shabat.json').then(response => response.json());
            poskimList = await fetch('poskim.txt').then(response => response.text()).then(text => text.split('\n').map(l => l.trim()).filter(l => l));
            poskimOptions = getOptionsHTML(poskimList);
            loadRandomQuestion();
        });

        function loadRandomQuestion() {
            // pick random
            currentQuestion = questions[Math.floor(Math.random() * questions.length)];
            document.getElementById('question-text').innerText = currentQuestion.question;
            svaraOpts = getOptionsHTML(currentQuestion.svarot);
            halachaOpts = getOptionsHTML(currentQuestion.psakim);
            // clear existing answers
            document.getElementById('answers-container').innerHTML = '';
            answerCount = 0;
            addAnswerField();
        }

        function esc(str) {
            return str.replace(/"/g, '&quot;')
        }

        function unesc(str) {
            return str.replace(/&quot;/g, '"')
        }
        
        function getOptionsHTML(list) {
            return list.map(p => `<option value="${esc(p)}">${p}</option>`).join('');
        }

        function addAnswerField() {
            answerCount++;
            const parentIndex = answerCount;
            childCounts[parentIndex] = 0;
            const container = document.getElementById("answers-container");
            const answerDiv = document.createElement("div");
            answerDiv.className = "mb-4 p-4 border rounded bg-gray-50 relative";
            answerDiv.id = `answer-${parentIndex}`;
            answerDiv.innerHTML = `
                <label class="block mb-2 font-medium answer-label">שיטה ${parentIndex}:</label>
                <div class="mb-2">
                    <label class="block text-sm font-medium">מי אומר כך?</label>
                    <select onchange="addPosek(${parentIndex}, this)" class="w-full p-2 border rounded">
                        <option value="">בחר פוסק</option>
                        ${poskimOptions}
                    </select>
                    <div id="posek-tags-${parentIndex}" class="mt-2"></div>
                </div>
                <div class="class-container" id="stances-1">
                    <div class="stance-block border rounded p-2 mb-2 bg-white relative">    
                        <div class="mb-2">
                            <label class="block text-sm font-medium">מהי עמדתו?</label>
                            <select id="stance-select" class="w-full p-2 border rounded" onchange="toggleHalachaFields(this, 'halacha-${parentIndex}')">
                                <option value="sover">סובר</option>
                                <option value="posek">פוסק</option>
                                <option value="metzaded">מצדד</option>
                                <option value="mistapek">מסתפק</option>
                                <option value="lechatchila">לכתחילה - בדיעבד</option>
                            </select>
                        </div>
                        <div class="mb-2" id="halacha-${parentIndex}">
                            <label class="block text-sm font-medium">מה הוא סובר?</label>
                            <select class="w-full p-2 border rounded">
                                <option value="">בחר סברא</option>
                                ${svaraOpts}
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="addStance(1)" class="bg-blue-500 text-white px-2 py-1 rounded">+ הוסף עמדה</button>
                <div id="inner-container-${parentIndex}" class="mr-8"></div>
                <button onclick="addInnerAnswer(${parentIndex})" class="mt-2 bg-royal-blue text-white px-3 py-1 rounded">הוסף שיטה בדעתו</button>
                <button onclick="removeAnswer(${parentIndex})" id="delete-btn-${parentIndex}" class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded" style="display: none;">מחק</button>
            `;
            container.appendChild(answerDiv);
            // stanceSelect = document.getElementById('stance-select');
            // stanceSelect.addEventListener('change', function() {

            // })
            adjustStanceOptions(document.getElementById('stance-select'));
            updateDeleteButtons();
            updateAnswerLabels();
        }

        function addInnerAnswer(parentIndex) {
            const parentDiv = document.getElementById(`answer-${parentIndex}`);
            childCounts[parentIndex]++;
            const childIndex = childCounts[parentIndex];
            const innerContainer = document.getElementById(`inner-container-${parentIndex}`);
            const childDiv = document.createElement("div");
            childDiv.className = "mb-4 p-3 border-r-4 border-gray-300 bg-white relative";
            childDiv.setAttribute("id", `answer-${parentIndex}-${childIndex}`);
            childDiv.innerHTML = `
                <label class="block mb-2 font-medium">שיטה בדעתו ${parentIndex}.${childIndex}:</label>
                <div class="mb-2">
                    <label class="block text-sm font-medium">מי אומר כך?</label>
                    <select onchange="addPosekChild(${parentIndex}, ${childIndex}, this)" class="w-full p-2 border rounded">
                        <option value="">בחר פוסק</option>
                        ${poskimOptions}
                    </select>
                    <div id="posek-tags-${parentIndex}-${childIndex}" class="mt-2"></div>
                </div>
                <div class="mb-2">
                    <label class="block text-sm font-medium">מהי עמדתו?</label>
                    <select class="w-full p-2 border rounded" onchange="toggleHalachaFields(this, 'halacha-${parentIndex}-${childIndex}')">
                        <option value="sover">סובר</option>
                        <option value="posek">פוסק</option>
                        <option value="metzaded">מצדד</option>
                        <option value="mistapek">מסתפק</option>
                        <option value="lechatchila">לכתחילה - בדיעבד</option>
                    </select>
                </div>
                <div class="mb-2" id="halacha-${parentIndex}-${childIndex}">
                    <label class="block text-sm font-medium">מהי ההלכה?</label>
                    <select class="w-full p-2 border rounded">
                        <option value="">בחר סברא</option>
                        ${svaraOpts}
                    </select>
                </div>
                <button class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded" onclick="removeInnerAnswer(${parentIndex}, ${childIndex})">מחק</button>
            `;
            innerContainer.appendChild(childDiv);
            updateInnerLabels(parentIndex);
        }

        function addPosek(index, select) {
            addPosekGeneric(`posek-tags-${index}`, select)
        }

        function addPosekChild(parentIndex, childIndex, select) {
            addPosekGeneric(`posek-tags-${parentIndex}-${childIndex}`, select);
        }

        function addPosekGeneric(containerId, select) {
            const posek = unesc(select.value);
            if (!posek) return;
            const tagContainer = document.getElementById(containerId);

            // prevent duplicates
            if (tagContainer.innerHTML.includes(posek)) return;

            const tag = document.createElement("span");
            tag.className = "tag";
            tag.innerText = posek;
            tag.onclick = () => tag.remove();
            tagContainer.appendChild(tag);
            select.value = "";
        }

        function addStance(posekIndex) {
            const container = document.getElementById(`stances-${posekIndex}`);
            const stanceCount = container.children.length + 1;
            const stanceDiv = document.createElement("div");
            stanceDiv.className = 'stance-block border rounded p-2 mb-2 bg-white relative';
            stanceDiv.innerHTML = `
                <div class="mb-2">
                    <label class="block text-sm font-medium">מהי עמדתו?</label>
                    <select id="stance-select" class="w-full p-2 border rounded" onchange="toggleHalachaFields(this, 'halacha-${posekIndex}-${stanceCount}')">
                        <option value="sover">סובר</option>
                        <option value="posek">פוסק</option>
                        <option value="metzaded">מצדד</option>
                        <option value="mistapek">מסתפק</option>
                        <option value="lechatchila">לכתחילה - בדיעבד</option>
                    </select>
                </div>
                <div class="mb-2" id="halacha-${posekIndex}-${stanceCount}">
                    <label class="block text-sm font-medium">מה הוא סובר?</label>
                    <select class="w-full p-2 border rounded">
                        <option value="">בחר סברא</option>
                        ${svaraOpts}
                    </select>
                </div>
                <button onclick="removeStance(this)" class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded hidden">מחק עמדה</button>
            `;
            container.appendChild(stanceDiv);
            updateStanceDeleteButtons(container);
        }

        function removeStance(button) {
            const stanceBlock = button.closest('.stance-block');
            stanceBlock.remove();
            const container = stanceBlock.parentElement;
            updateStanceDeleteButtons(container);
        }

        function updateStanceDeleteButtons(container) {
            const stanceBlocks = container.querySelectorAll('.stance-block');
            stanceBlocks.forEach((block, i) => {
                const deleteBtn = block.querySelector('button');
                deleteBtn.classList.toggle('hidden', stanceBlocks.length <= 1);
            });
        }

        function toggleHalachaFields(select, halachaId) {
            const halachaDiv = document.getElementById(halachaId);
            if (select.value === "mistapek" || select.value === "lechatchila" || ((select.value === "posek" || select.value === "metzaded") && currentQuestion.svarot.length > 0)) {
                let secondField = "בחר הלכה משנית";
                let secondOpts = halachaOpts;
                if (select.value === "posek" || select.value === "metzaded") {
                    secondField = "בחר סברא";
                    secondOpts = svaraOpts;
                } else if (select.value === "lechatchila") secondField = "בחר הלכה בדיעבד"
                halachaDiv.innerHTML = `
                    <label class="block text-sm font-medium">מהי ההלכה?</label>
                    <select id="select1" class="w-full p-2 border rounded mb-2">
                        <option value="">בחר הלכה</option>
                        ${halachaOpts}
                    </select>
                    <select id="select2" class="w-full p-2 border rounded">
                        <option value="">${secondField}</option>
                        ${secondOpts}
                    </select>
                `;
                setupMutualExclusion(document.getElementById("select1"), document.getElementById("select2"));
            } else {
                let selectField = "בחר הלכה";
                let selectOpts = halachaOpts;
                if (select.value === "sover") {
                    selectField = "בחר סברא";
                    selectOpts = svaraOpts;
                }
                halachaDiv.innerHTML = `
                    <label class="block text-sm font-medium">מה הוא סובר?</label>
                    <select class="w-full p-2 border rounded">
                        <option value="">${selectField}</option>
                        ${selectOpts}
                    </select>
                `;
            }
        }

        function adjustStanceOptions(stanceSelect) {
            if (currentQuestion.psakim.length === 0) {
                Array.from(stanceSelect.options).forEach(opt => {
                    if (opt.value !== 'sover') {
                        opt.disabled = true;
                    } else {
                        opt.disabled = false;
                    }
                })
            } 
        }

        function setupMutualExclusion(select1, select2) {
            select1.addEventListener('change', () => updateDisabledOptions(select1, select2));
            select2.addEventListener('change', () => updateDisabledOptions(select2, select1));
        }

        function updateDisabledOptions(sourceSelect, targetSelect) {
            const selectedValue = sourceSelect.value;
            Array.from(targetSelect.options).forEach(opt => {
                if (opt.value === selectedValue && selectedValue !== '') {
                    opt.disabled = true;
                } else {
                    opt.disabled = false;
                }
            });
        }

        function removeAnswer(index) {
            document.getElementById(`answer-${index}`).remove();
            updateDeleteButtons();
            updateAnswerLabels();
        }

        function removeInnerAnswer(parentIndex, childIndex) {
            document.getElementById(`answer-${parentIndex}-${childIndex}`).remove();
            updateInnerLabels(parentIndex);
        }

        function updateDeleteButtons() {
            const answers = document.querySelectorAll("[id^='answer-'][id$='']");
            answers.forEach((answer, i) => {
                const deleteBtn = answer.querySelector("button[onclick^='removeAnswer']");
                if (deleteBtn) deleteBtn.style.display = answers.length > 1 ? "block" : "none";
            });
        }

        function updateAnswerLabels() {
            const answers = document.querySelectorAll("#answers-container > div[id^='answer-']");
            answers.forEach((answer, i) => {
                const label = answer.querySelector(".answer-label");
                label.textContent = `שיטה ${i + 1}:`;
            });
        }

        function updateInnerLabels(parentIndex) {
            const innerContainer = document.getElementById(`inner-container-${parentIndex}`);
            const children = innerContainer.querySelectorAll("div[id^='answer-${parentIndex}-']");
            children.forEach((child, i) => {
                const label = child.querySelector(".font-medium");
                label.textContent = `שיטה בדעתו ${parentIndex}.${i+1}:`;
            });
        }
    </script>
</body>
</html>
